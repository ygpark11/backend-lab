name: Deploy Brain (Catalog Service)

# 1. 트리거:
on:
  push:
    branches: [ "master" ]
    paths:
      - 'msa/apps/catalog-service/**'       # 자바 쪽 코드가 변경되거나
      - 'msa/docker-compose.brain.yml'      # 1호기 설정이 변경되거나
      - '.github/workflows/deploy-brain.yml' # 이 파일 자체가 변경될 때만 실행

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 코드 내려받기
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. 자바(JDK 17) 세팅
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. Gradle 캐싱 (빌드 속도를 엄청 빠르게 해줌!)
      - name: Gradle Caching
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 4. Gradle 실행 권한 부여
      - name: Grant execute permission for gradlew
        run: chmod +x msa/apps/catalog-service/catalog-service/gradlew

      # 5. 빌드 (테스트 제외하고 빠르게)
      - name: Build with Gradle
        run: |
          cd msa/apps/catalog-service/catalog-service
          ./gradlew clean build -x test

      # 6. 도커 허브 로그인 (제자님이 등록한 시크릿 사용)
      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 7. 도커 이미지 빌드 & 허브로 전송 (Push)
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: msa/apps/catalog-service/catalog-service
          file: msa/apps/catalog-service/catalog-service/Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/ps-tracker-api:latest

      # 8. 1호기(Brain) 서버에 접속해서 배포 명령 내리기
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd ~/backend-lab/msa

            # 1. 최신 설정파일(docker-compose 등) 받기
            git fetch --all
            git reset --hard origin/master
            git pull origin master

            # 2. 방금 올라온 따끈따끈한 이미지 받아오기
            docker compose -f docker-compose-brain.yml pull catalog-service

            # 3. 컨테이너 교체
            docker compose -f docker-compose-brain.yml up -d catalog-service

            # 4. 뒷정리 (이미지 찌꺼기 청소)
            docker image prune -f