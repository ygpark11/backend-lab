name: Deploy Face (Frontend)

on:
  push:
    branches: [ "master" ]
    paths:
      - 'msa/apps/frontend/**'            # Î¶¨Ïï°Ìä∏ ÏΩîÎìúÍ∞Ä Î∞îÎÄåÍ±∞ÎÇò
      - 'msa/docker-compose-brain.yml'    # 1Ìò∏Í∏∞ ÏÑ§Ï†ï(Nginx Îì±)Ïù¥ Î∞îÎÄåÍ±∞ÎÇò
      - '.github/workflows/deploy-face.yml' # Ïù¥ ÌååÏùº ÏûêÏ≤¥Í∞Ä Î∞îÎÄî Îïå

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. ÏΩîÎìú Ï≤¥ÌÅ¨ÏïÑÏõÉ
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. ÎèÑÏª§ Î°úÍ∑∏Ïù∏
      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 3. ÎπåÎìú & Ìë∏Ïãú (Î≥ÄÏàò Ï£ºÏûÖ Ìè¨Ìï®)
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: msa/apps/frontend
          file: msa/apps/frontend/Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/ps-tracker-web:latest
          # üëá [ÌïµÏã¨] Î¶¨Ïï°Ìä∏ ÎπåÎìú ÏãúÏ†êÏóê ÌôòÍ≤ΩÎ≥ÄÏàò Ï£ºÏûÖ (Secrets -> ARG)
          build-args: |
            VITE_FIREBASE_API_KEY=${{ secrets.VITE_FIREBASE_API_KEY }}
            VITE_FIREBASE_AUTH_DOMAIN=${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
            VITE_FIREBASE_PROJECT_ID=${{ secrets.VITE_FIREBASE_PROJECT_ID }}
            VITE_FIREBASE_STORAGE_BUCKET=${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
            VITE_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
            VITE_FIREBASE_APP_ID=${{ secrets.VITE_FIREBASE_APP_ID }}
            VITE_FIREBASE_MEASUREMENT_ID=${{ secrets.VITE_FIREBASE_MEASUREMENT_ID }}
            VITE_FIREBASE_VAPID_KEY=${{ secrets.VITE_FIREBASE_VAPID_KEY }}
            VITE_GA_MEASUREMENT_ID=${{ secrets.VITE_GA_MEASUREMENT_ID }}
            VITE_BANK_NAME=${{ secrets.VITE_BANK_NAME }}
            VITE_BANK_ACCOUNT=${{ secrets.VITE_BANK_ACCOUNT }}
            VITE_BANK_HOLDER=${{ secrets.VITE_BANK_HOLDER }}

      # 4. ÏÑúÎ≤Ñ Î∞∞Ìè¨ (SSH)
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd ~/backend-lab/msa
            
            # ÏµúÏã† ÏÑ§Ï†ï ÌååÏùº Î∞õÍ∏∞
            git pull origin master

            # 1. ÏµúÏã† Ïù¥ÎØ∏ÏßÄ ÎãπÍ≤®Ïò§Í∏∞
            docker compose -f docker-compose-brain.yml pull frontend
            
            # 2. Ïª®ÌÖåÏù¥ÎÑà ÍµêÏ≤¥
            docker compose -f docker-compose-brain.yml up -d frontend
            
            # 3. Ï∞åÍ∫ºÍ∏∞ Ï≤≠ÏÜå
            docker image prune -f