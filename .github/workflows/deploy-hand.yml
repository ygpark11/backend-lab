name: Deploy Hand (Collector)

on:
  push:
    branches: [ "master" ]
    paths:
      - 'msa/apps/collector-service/**'   # íŒŒì´ì¬ ì½”ë“œê°€ ë°”ë€Œê±°ë‚˜
      - 'msa/docker-compose-hand.yml'     # 2í˜¸ê¸° ì„¤ì •ì´ ë°”ë€” ë•Œ
      - '.github/workflows/deploy-hand.yml'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: msa/apps/collector-service
          file: msa/apps/collector-service/Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/ps-tracker-collector:latest

      - name: Deploy to Server (Node 2) via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST_HAND }}
          username: ubuntu
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd ~/backend-lab/msa
            
            # 1. ìµœì‹  ì„¤ì • ë°›ê¸°
            git pull origin master

            # 2. ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ê°•ì œ ì¢…ë£Œ ë° ì‚­ì œ
            docker compose -f docker-compose-hand.yml down
            
            # 3. í˜¸ìŠ¤íŠ¸ì— ë‚¨ì•„ìˆëŠ” ì¢€ë¹„ í¬ë¡¬ í”„ë¡œì„¸ìŠ¤ ì‚¬ì‚´ ğŸ”«
            # (ì´ì „ ì‹¤í–‰ì—ì„œ ì•ˆ ì£½ê³  ë‚¨ì•„ìˆëŠ” í¬ë¡¬ë“¤ì´ ë©”ëª¨ë¦¬ ë¨¹ëŠ” ê²ƒì„ ë°©ì§€)
            sudo pkill -f chrome || true
            sudo pkill -f playwright || true
            
            # 4. ë©”ëª¨ë¦¬ ìºì‹œ ë¹„ìš°ê¸° (OS ë ˆë²¨ ì²­ì†Œ)
            # (ë°°í¬ ì§ì „ì— ë¨ì„ ìµœëŒ€í•œ í™•ë³´)
            sudo sync && sudo sysctl -w vm.drop_caches=3 || true

            # 5. ìµœì‹  ì´ë¯¸ì§€ ë‹¹ê²¨ì˜¤ê¸°
            docker compose -f docker-compose-hand.yml pull collector-service
            
            # 6. ì»¨í…Œì´ë„ˆ ê¹¨ë—í•˜ê²Œ ìƒˆë¡œ ì‹œì‘
            docker compose -f docker-compose-hand.yml up -d collector-service
            
            # 7. ë„ì»¤ ì°Œêº¼ê¸° ì´ë¯¸ì§€ ì •ë¦¬
            docker image prune -f