# Level 2: μ„¤μ • μλ™ μƒλ΅κ³ μΉ¨ (Spring Cloud Bus & RabbitMQ)

## π“ ν•™μµ λ©ν‘

- μ¤‘μ•™ μ„¤μ • λ³€κ²½ μ‹, κ° μ„λΉ„μ¤λ¥Ό μ¬κΈ°λ™ν•΄μ•Ό ν•λ” λ¬Έμ μ μ„ μ΄ν•΄ν•¨.
- **Spring Cloud Bus**μ κ°λ…μ„ ν•™μµν•μ—¬, λ‹¨ ν• λ²μ λ…λ ΉμΌλ΅ λ¨λ“  μ„λΉ„μ¤μ μ„¤μ •μ„ λ™μ μΌλ΅ κ°±μ‹ ν•λ” λ°©λ²•μ„ μµν.
- Spring Cloud Busμ λ©”μ‹μ§€ λΈλ΅μ»¤λ΅ **RabbitMQ**λ¥Ό μ„ νƒν• μ΄μ λ¥Ό μ΄ν•΄ν•κ³ , Dockerλ¥Ό ν†µν•΄ μ§μ ‘ κµ¬μ¶• λ° μ—°λ™ν•¨.
- **`@RefreshScope`**μ™€ **Actuator**μ `bus-refresh` μ—”λ“ν¬μΈνΈλ¥Ό μ‚¬μ©ν•μ—¬ μ‹¤μ  μ„¤μ • λ³€κ²½μ„ ν…μ¤νΈν•¨.

## π“ ν•™μµ λ©μ°¨

1.  **[Spring Cloud Bus: MSAμ μν™ λ²„μ¤](#1-spring-cloud-bus-msaμ-μν™-λ²„μ¤)**
2.  **[μ™ RabbitMQμΈκ°€?: Kafkaμ™€μ λΉ„κµ](#2-μ™-rabbitmqμΈκ°€-kafkaμ™€μ-λΉ„κµ)**
3.  **[κµ¬ν„: μλ™ λ°©μ†΅ μ‹μ¤ν… κµ¬μ¶•](#3-κµ¬ν„-μλ™-λ°©μ†΅-μ‹μ¤ν…-κµ¬μ¶•)**

---

## π€ ν•µμ‹¬ ν•™μµ λ‚΄μ©

### 1. Spring Cloud Bus: MSAμ μν™ λ²„μ¤ π

- **λ¬Έμ μ **: `Config Server`λ¥Ό μ‚¬μ©ν•΄λ„, Gitμ μ„¤μ • λ³€κ²½ λ‚΄μ©μ€ κ° μ„λΉ„μ¤κ°€ μ‹μ‘λ  λ• ν• λ²λ§ κ°€μ Έκ°. λ³€κ²½ μ‚¬ν•­μ„ μ μ©ν•λ ¤λ©΄ λ¨λ“  μ„λΉ„μ¤λ¥Ό μλ™μΌλ΅ μ¬μ‹μ‘ν•κ±°λ‚, κ° μ„λΉ„μ¤μ `/actuator/refresh` μ—”λ“ν¬μΈνΈλ¥Ό μΌμΌμ΄ νΈμ¶ν•΄μ•Ό ν•¨.
- **κ°λ…**: λ¨λ“  λ§μ΄ν¬λ΅μ„λΉ„μ¤λ¥Ό μ—°κ²°ν•λ” λ³΄μ΄μ§€ μ•λ” 'μν™ λ²„μ¤'. ν• μ„λΉ„μ¤μ— μ „λ‹¬λ 'μƒλ΅κ³ μΉ¨' λ…λ Ήμ„ λ²„μ¤μ— νƒ€κ³  μλ” λ¨λ“  μ„λΉ„μ¤μ—κ² μ „ν(Broadcast)ν•λ” μ—­ν• μ„ ν•¨.
- **λ™μ‘ μ›λ¦¬**: λ©”μ‹μ§€ λΈλ΅μ»¤(RabbitMQ, Kafka)λ¥Ό ν†µν•΄ μ΄λ²¤νΈ(μ„¤μ • λ³€κ²½)λ¥Ό λ¨λ“  μ„λΉ„μ¤μ— μ „λ‹¬.

### 2. μ™ RabbitMQμΈκ°€?: Kafkaμ™€μ λΉ„κµ

- `Spring Cloud Bus`μ μ„λ¬΄λ” "μ„¤μ •μ΄ λ°”λ€μ—μΌλ‹ μƒλ΅κ³ μΉ¨ ν•΄!" λΌλ” **κ°€λ³κ³  μΌμ‹μ μΈ 'μ•λ¦Ό'**μ„ μ „λ‹¬ν•λ” κ²ƒ. μ΄ λ©μ μ„ μ„ν•΄μ„λ” λ€μ©λ‰ λ°μ΄ν„° λ³΄κ΄€μ΄ λ©μ μΈ 'CCTV(μΉ΄ν”„μΉ΄)'λ³΄λ‹¤, μ‹ μ†ν• λ©”μ‹μ§€ μ „λ‹¬μ΄ λ©μ μΈ 'κΈ΄κΈ‰ λ°©μ†΅ μ‹μ¤ν…(RabbitMQ)'μ΄ λ” μ ν•©ν•κ³  ν¨μ¨μ μ„.

| κµ¬λ¶„ | **μΉ΄ν”„μΉ΄ (Kafka)** | **RabbitMQ** |
| :--- | :--- | :--- |
| **λΉ„μ ** | π“Ή CCTV λ…Ήν™” μ‹μ¤ν… | π” κΈ΄κΈ‰ λ°©μ†΅ μ‹μ¤ν… |
| **ν•µμ‹¬ λ©μ ** | μ΄λ²¤νΈ **'κΈ°λ΅' λ° 'λ³΄κ΄€'** | λ©”μ‹μ§€ **'μ‹ μ†' λ° 'μ•μ „' μ „λ‹¬** |
| **μ ν•©ν• μ©λ„**| - λ€μ©λ‰ λ°μ΄ν„° νμ΄ν”„λΌμΈ<br>- μ΄λ²¤νΈ μ†μ‹± | - κ°€λ²Όμ΄ μ•λ¦Ό, RPC<br>- **`Spring Cloud Bus`** |

- **κ²°λ΅ **: μ΄λ―Έ μΉ΄ν”„μΉ΄λ¥Ό μ΄μ μ¤‘μ΄λΌ μΈν”„λΌλ¥Ό ν†µμΌν•κ³  μ‹¶λ‹¤λ©΄ μΉ΄ν”„μΉ΄λ¥Ό μ“Έ μλ„ μμ§€λ§, μ•„ν‚¤ν…μ²μ λ…ν™•μ„±κ³Ό μ—­ν•  λ¶„λ¦¬λ¥Ό μ„ν•΄ `Spring Cloud Bus` μ©λ„λ΅λ” RabbitMQλ¥Ό μ‚¬μ©ν•λ” κ²ƒμ΄ λ” μΌλ°μ μ΄κ³  ν¨μ¨μ μΈ μ„¤κ³„μ„.

### 3. κµ¬ν„: μλ™ λ°©μ†΅ μ‹μ¤ν… κµ¬μ¶•

- **1λ‹¨κ³„ (RabbitMQ μ„¤μΉ)**: `docker-compose`λ¥Ό μ‚¬μ©ν•μ—¬ RabbitMQ Management μ΄λ―Έμ§€λ¥Ό μ‹¤ν–‰.
- **2λ‹¨κ³„ (μμ΅΄μ„± μ¶”κ°€)**: λ¨λ“  μ„λΉ„μ¤(`config`, `gateway`, `user`)μ `build.gradle`μ— `spring-cloud-starter-bus-amqp`μ™€ `spring-boot-starter-actuator` μ¶”κ°€.
- **3λ‹¨κ³„ (μ„¤μ • μ—°κ²°)**: λ¨λ“  μ„λΉ„μ¤κ°€ RabbitMQμ— μ ‘μ†ν•  μ μλ„λ΅ `backend-lab-config`μ κ³µν†µ `application.yml`μ— `spring.rabbitmq` μ„¤μ • μ¶”κ°€.
- **4λ‹¨κ³„ (μƒλ΅κ³ μΉ¨ λ€μƒ μ§€μ •)**: μ„¤μ • λ³€κ²½μ΄ ν•„μ”ν• μ»΄ν¬λ„νΈ(`UserController`)μ— `@RefreshScope` μ–΄λ…Έν…μ΄μ… μ¶”κ°€.
- **5λ‹¨κ³„ (μ—”λ“ν¬μΈνΈ λ…Έμ¶)**: κ° ν΄λΌμ΄μ–ΈνΈ μ„λΉ„μ¤μ `application.yml`μ— `management.endpoints.web.exposure.include: bus-refresh` μ„¤μ • μ¶”κ°€.

---

## π’» μµμΆ… ν…μ¤νΈ

1.  `backend-lab-config` Git μ €μ¥μ†μ `user-service.yml`μ— ν…μ¤νΈμ© λ©”μ‹μ§€(`test.message`) μμ • ν›„ `push`.
2.  μ•„λ¬΄ μ„λΉ„μ¤(μ: `user-service`)μ `/actuator/busrefresh` μ—”λ“ν¬μΈνΈλ΅ `POST` μ”μ²­ μ „μ†΅.
    - **μ£Όμ**: μµμ‹  λ²„μ „μ—μ„λ” ν•μ΄ν” μ—†λ” `busrefresh` μ‚¬μ©.
    ```bash
    curl -X POST http://localhost:8081/actuator/busrefresh
    ```
3.  `user-service`μ `/users/message` APIλ¥Ό λ‹¤μ‹ νΈμ¶ν•μ—¬, **μ„λΉ„μ¤ μ¬κΈ°λ™ μ—†μ΄** λ©”μ‹μ§€κ°€ λ³€κ²½λμ—μμ„ ν™•μΈ.