package com.pstracker.catalog_service.catalog.scheduler;

import com.pstracker.catalog_service.ai.service.AiService;
import com.pstracker.catalog_service.catalog.domain.Game;
import com.pstracker.catalog_service.catalog.repository.GameRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.concurrent.TimeUnit;

@Slf4j
@Component
@RequiredArgsConstructor
public class AiDescriptionScheduler {

    private final GameRepository gameRepository;
    private final AiService aiService;

    // íƒ€ê²Ÿ ë¬¸êµ¬ ì •ì˜ (ì´ê²Œ ë³´ì´ë©´ AI ìš”ì•½ ëŒ€ìƒì„)
    private static final String TARGET_DESCRIPTION = "Full Data Crawler";

    /**
     * â° 10ë¶„ë§ˆë‹¤ ì‹¤í–‰ (Rate Limit ë³´í˜¸ & ì˜¤ë¼í´ ë¬´ë£Œ í´ë¼ìš°ë“œ ë¶€í•˜ ë°©ì§€)
     * "Full Data Crawler" ì„¤ëª…ì´ ìˆëŠ” ê²Œì„ì„ ì°¾ì•„ AI ìš”ì•½ìœ¼ë¡œ êµì²´í•©ë‹ˆë‹¤.
     */
    @Scheduled(fixedDelay = 10, timeUnit = TimeUnit.MINUTES)
    @Transactional
    public void autoGenerateDescriptions() {
        log.info("ğŸ¤– AI Curator Scheduler Started... Searching for '{}'", TARGET_DESCRIPTION);

        // 1. "Full Data Crawler"ë¼ê³  ì íŒ ê²Œì„ 5ê°œ ì¡°íšŒ
        List<Game> targets = gameRepository.findTop5ByDescriptionOrderByIdDesc(TARGET_DESCRIPTION);

        if (targets.isEmpty()) {
            log.info("âœ¨ ëª¨ë“  ê²Œì„ì˜ ì„¤ëª…ì´ ìµœì‹ í™”ë˜ì—ˆìŠµë‹ˆë‹¤. (ëŒ€ìƒ ì—†ìŒ)");
            return;
        }

        int successCount = 0;

        // 2. ìˆœíšŒí•˜ë©° AI í˜¸ì¶œ
        for (Game game : targets) {
            try {
                // Geminiì—ê²Œ ìš”ì•½ ìš”ì²­
                String summary = aiService.summarizeGame(game.getName());

                if (summary != null && !summary.isBlank()) {
                    // 3. ê²Œì„ ì—”í‹°í‹° ì—…ë°ì´íŠ¸ (Dirty Checkingìœ¼ë¡œ ìë™ ì €ì¥)
                    // ì£¼ì˜: Game ì—”í‹°í‹°ì— updateDescription ë©”ì„œë“œê°€ ìˆì–´ì•¼ í•¨!
                    game.updateDescription(summary);
                    successCount++;

                    // API í˜¸ì¶œ ê°„ê²© ì¡°ì ˆ (5ì´ˆ íœ´ì‹)
                    Thread.sleep(5000);
                } else {
                    log.warn("âš ï¸ ìš”ì•½ ìƒì„± ì‹¤íŒ¨: {}", game.getName());
                }

            } catch (InterruptedException ie) {
                Thread.currentThread().interrupt();
            } catch (Exception e) {
                log.error("âŒ Error processing game {}: {}", game.getName(), e.getMessage());
            }
        }

        log.info("âœ… AI Curator Finished. Updated {}/{} games.", successCount, targets.size());
    }
}