package com.pstracker.catalog_service.catalog.scheduler;

import com.pstracker.catalog_service.ai.service.AiService;
import com.pstracker.catalog_service.catalog.domain.Game;
import com.pstracker.catalog_service.catalog.repository.GameRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.context.annotation.Profile;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

@Slf4j
@Component
@RequiredArgsConstructor
@Profile("prod")
public class AiDescriptionScheduler {

    private final GameRepository gameRepository;
    private final AiService aiService;

    // íƒ€ê²Ÿ ë¬¸êµ¬ ì •ì˜ (ì´ê²Œ ë³´ì´ë©´ AI ìš”ì•½ ëŒ€ìƒì„)
    private static final String TARGET_DESCRIPTION = "Full Data Crawler";

    /**
     * â° ë§¤ì¼ ìƒˆë²½ 1ì‹œ 0ë¶„ 0ì´ˆ ì‹¤í–‰ (KST ê¸°ì¤€)
     * í•˜ë£¨ í• ë‹¹ëŸ‰(20ê°œ)ë§Œí¼ "Full Data Crawler" ì„¤ëª…ì„ ì°¾ì•„ AI ìš”ì•½ìœ¼ë¡œ êµì²´í•©ë‹ˆë‹¤.
     */
    @Scheduled(cron = "0 0 1 * * *", zone = "Asia/Seoul")
    @Transactional
    public void autoGenerateDescriptions() {
        log.info("ğŸ¤– AI Curator Scheduler Started... Searching for '{}'", TARGET_DESCRIPTION);

        // 1. "Full Data Crawler"ë¼ê³  ì íŒ ê²Œì„ 20ê°œ ì¡°íšŒ
        List<Game> targets = gameRepository.findTop20ByDescriptionOrderByIdDesc(TARGET_DESCRIPTION);

        if (targets.isEmpty()) {
            log.info("âœ¨ ëª¨ë“  ê²Œì„ì˜ ì„¤ëª…ì´ ìµœì‹ í™”ë˜ì—ˆìŠµë‹ˆë‹¤. (ëŒ€ìƒ ì—†ìŒ)");
            return;
        }

        int successCount = 0;

        // 2. ìˆœíšŒí•˜ë©° AI í˜¸ì¶œ
        for (Game game : targets) {
            try {
                // Geminiì—ê²Œ ìš”ì•½ ìš”ì²­
                String summary = aiService.summarizeGame(game.getName());

                if (summary != null && !summary.isBlank()) {
                    // 3. ê²Œì„ ì—”í‹°í‹° ì—…ë°ì´íŠ¸
                    game.updateDescription(summary);
                    successCount++;

                    log.info("âœ… Updated: {} ({}/{})", game.getName(), successCount, targets.size());

                    // API í˜¸ì¶œ ê°„ê²© ì¡°ì ˆ (10ì´ˆ íœ´ì‹)
                    Thread.sleep(10_000);
                } else {
                    log.warn("âš ï¸ ìš”ì•½ ìƒì„± ì‹¤íŒ¨: {}", game.getName());
                }

            } catch (InterruptedException ie) {
                Thread.currentThread().interrupt();
                log.error("â›” ìŠ¤ë ˆë“œ ì¸í„°ëŸ½íŠ¸ ë°œìƒ");
                break;
            } catch (Exception e) {
                log.error("âŒ API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ! Game: {}, Error: {}", game.getName(), e.getMessage());
                try {
                    Thread.sleep(60_000);
                } catch (InterruptedException ex) {
                    Thread.currentThread().interrupt();
                }
            }
        }

        log.info("âœ… [Daily Batch] Finished. Updated {}/{} games.", successCount, targets.size());
    }
}